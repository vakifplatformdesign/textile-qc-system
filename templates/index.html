<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Textile QC Analysis System</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #2980B9 0%, #3498DB 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        /* Main Content */
        .main-content {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        /* Image Upload Section */
        .image-section {
            display: flex;
            gap: 30px;
            justify-content: center;
            margin-bottom: 40px;
        }

        .image-upload {
            flex: 1;
            max-width: 450px;
            text-align: center;
        }

        .image-upload h3 {
            color: #2C3E50;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .upload-box {
            border: 3px dashed #3498DB;
            border-radius: 15px;
            padding: 40px 20px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .upload-box:hover {
            border-color: #2980B9;
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .upload-box.has-image {
            border-color: #27AE60;
            background: #e8f8f5;
        }

        .upload-icon {
            font-size: 3em;
            color: #3498DB;
            margin-bottom: 10px;
        }

        .preview-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
        }

        .preview-image.show {
            display: block;
        }

        input[type="file"] {
            display: none;
        }

        /* Buttons */
        .button-group {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .btn {
            padding: 15px 40px;
            font-size: 1.1em;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .btn-settings {
            background: linear-gradient(135deg, #F39C12 0%, #E67E22 100%);
            color: white;
        }

        .btn-analyze {
            background: linear-gradient(135deg, #27AE60 0%, #2ECC71 100%);
            color: white;
            font-size: 1.3em;
            padding: 20px 50px;
        }

        .btn-analyze:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            overflow-y: auto;
        }

        .modal.show {
            display: block;
        }

        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 0;
            max-width: 900px;
            border-radius: 15px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #2980B9 0%, #3498DB 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.8em;
        }

        .close {
            font-size: 2em;
            cursor: pointer;
            color: white;
            transition: all 0.3s ease;
        }

        .close:hover {
            transform: scale(1.2);
        }

        .modal-body {
            padding: 30px;
            max-height: 70vh;
            overflow-y: auto;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 25px;
        }

        .tab {
            padding: 12px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #7F8C8D;
        }

        .tab:hover {
            color: #2980B9;
        }

        .tab.active {
            border-bottom-color: #2980B9;
            color: #2980B9;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2C3E50;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3498DB;
        }

        /* Loading Animation */
        .loading-overlay {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(44, 62, 80, 0.95);
            justify-content: center;
            align-items: center;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-content {
            text-align: center;
            color: white;
        }

        .spinner {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            border: 8px solid rgba(255,255,255,0.2);
            border-top: 8px solid #3498DB;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-content h2 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .loading-content p {
            font-size: 1.2em;
            opacity: 0.8;
        }

        /* Results Section */
        .results {
            display: none;
            background: linear-gradient(135deg, #27AE60 0%, #2ECC71 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-top: 30px;
        }

        .results.show {
            display: block;
            animation: slideIn 0.5s ease;
        }

        .results h2 {
            font-size: 2em;
            margin-bottom: 20px;
        }

        .download-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 25px;
        }

        .btn-download {
            background: white;
            color: #27AE60;
            padding: 15px 35px;
            border-radius: 10px;
            text-decoration: none;
            font-weight: bold;
            font-size: 1.1em;
            transition: all 0.3s ease;
            display: inline-block;
        }

        .btn-download:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        /* Error Message */
        .error-message {
            display: none;
            background: #E74C3C;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
        }

        .error-message.show {
            display: block;
            animation: slideIn 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üé® Textile Quality Control System</h1>
            <p>Professional Color & Pattern Analysis</p>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Image Upload Section -->
            <div class="image-section">
                <!-- Reference Image -->
                <div class="image-upload">
                    <h3>üì∑ Reference Image</h3>
                    <div class="upload-box" id="refUploadBox" onclick="document.getElementById('refInput').click()">
                        <div class="upload-icon">‚¨ÜÔ∏è</div>
                        <p><strong>Click to upload</strong></p>
                        <p style="font-size: 0.9em; color: #7F8C8D; margin-top: 10px;">Supported: JPG, PNG, BMP, TIFF</p>
                        <img id="refPreview" class="preview-image" alt="Reference Preview">
                    </div>
                    <input type="file" id="refInput" accept="image/*">
                </div>

                <!-- Test Image -->
                <div class="image-upload">
                    <h3>üì∑ Test/Sample Image</h3>
                    <div class="upload-box" id="testUploadBox" onclick="document.getElementById('testInput').click()">
                        <div class="upload-icon">‚¨ÜÔ∏è</div>
                        <p><strong>Click to upload</strong></p>
                        <p style="font-size: 0.9em; color: #7F8C8D; margin-top: 10px;">Supported: JPG, PNG, BMP, TIFF</p>
                        <img id="testPreview" class="preview-image" alt="Test Preview">
                    </div>
                    <input type="file" id="testInput" accept="image/*">
                </div>
            </div>

            <!-- Buttons -->
            <div class="button-group">
                <button class="btn btn-settings" onclick="openSettings()">‚öôÔ∏è Advanced Settings</button>
            </div>

            <div style="text-align: center;">
                <button class="btn btn-analyze" id="analyzeBtn" onclick="startAnalysis()" disabled>
                    üöÄ Start Analysis
                </button>
            </div>

            <!-- Error Message -->
            <div class="error-message" id="errorMessage"></div>

            <!-- Results Section -->
            <div class="results" id="results">
                <h2>‚úÖ Analysis Complete!</h2>
                <p style="font-size: 1.2em; margin: 15px 0;">Your comprehensive quality control reports have been generated.</p>
                <div class="download-buttons" id="downloadButtons"></div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è Advanced Settings</h2>
                <span class="close" onclick="closeSettings()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <div class="tab active" onclick="switchTab(0)">General</div>
                    <div class="tab" onclick="switchTab(1)">Color Analysis</div>
                    <div class="tab" onclick="switchTab(2)">Pattern Analysis</div>
                    <div class="tab" onclick="switchTab(3)">Report Sections</div>
                </div>

                <!-- Tab 0: General -->
                <div class="tab-content active" id="tab0">
                    <div class="form-group">
                        <label>Operator Name:</label>
                        <input type="text" id="operator_name" value="Operator">
                    </div>
                    <div class="form-group">
                        <label>Number of Sample Points:</label>
                        <input type="number" id="num_sample_points" value="5" min="3" max="10">
                    </div>
                </div>

                <!-- Tab 1: Color Analysis -->
                <div class="tab-content" id="tab1">
                    <div class="form-group">
                        <label>ŒîE Threshold (PASS):</label>
                        <input type="number" id="delta_e_threshold" value="2.0" step="0.1" min="0">
                    </div>
                    <div class="form-group">
                        <label>ŒîE Conditional:</label>
                        <input type="number" id="delta_e_conditional" value="3.5" step="0.1" min="0">
                    </div>
                    <div class="form-group">
                        <label>Observer Angle:</label>
                        <select id="observer_angle">
                            <option value="2">2¬∞</option>
                            <option value="10">10¬∞</option>
                        </select>
                    </div>
                </div>

                <!-- Tab 2: Pattern Analysis -->
                <div class="tab-content" id="tab2">
                    <div class="form-group">
                        <label>SSIM PASS Threshold:</label>
                        <input type="number" id="ssim_pass_threshold" value="0.95" step="0.01" min="0" max="1">
                    </div>
                    <div class="form-group">
                        <label>SSIM Conditional Threshold:</label>
                        <input type="number" id="ssim_conditional_threshold" value="0.90" step="0.01" min="0" max="1">
                    </div>
                </div>

                <!-- Tab 3: Report Sections -->
                <div class="tab-content" id="tab3">
                    <div class="form-group">
                        <label><input type="checkbox" id="enable_color_unit" checked> Color Unit</label>
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="enable_pattern_unit" checked> Pattern Unit</label>
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="enable_pattern_repetition" checked> Pattern Repetition Unit</label>
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="enable_spectrophotometer" checked> Spectrophotometer Simulation</label>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-settings" onclick="closeSettings()">‚úÖ Apply Settings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <h2>‚öôÔ∏è Analysis in Progress</h2>
            <p>Performing color and pattern analysis. This may take a moment...</p>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script>
        let refFile = null;
        let testFile = null;

        // Handle file uploads
        document.getElementById('refInput').addEventListener('change', function(e) {
            handleFileSelect(e, 'ref');
        });

        document.getElementById('testInput').addEventListener('change', function(e) {
            handleFileSelect(e, 'test');
        });

        function handleFileSelect(event, type) {
            const file = event.target.files[0];
            if (!file) return;

            if (type === 'ref') {
                refFile = file;
                document.getElementById('refUploadBox').classList.add('has-image');
            } else {
                testFile = file;
                document.getElementById('testUploadBox').classList.add('has-image');
            }

            // Preview
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById(type + 'Preview');
                preview.src = e.target.result;
                preview.classList.add('show');
            };
            reader.readAsDataURL(file);

            // Enable analyze button if both files selected
            if (refFile && testFile) {
                document.getElementById('analyzeBtn').disabled = false;
            }
        }

        function openSettings() {
            document.getElementById('settingsModal').classList.add('show');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('show');
        }

        function switchTab(index) {
            // Remove active from all tabs
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            // Add active to selected tab
            document.querySelectorAll('.tab')[index].classList.add('active');
            document.getElementById('tab' + index).classList.add('active');
        }

        async function startAnalysis() {
            if (!refFile || !testFile) {
                showError('Please upload both images');
                return;
            }

            // Show loading
            document.getElementById('loadingOverlay').classList.add('show');
            document.getElementById('errorMessage').classList.remove('show');
            document.getElementById('results').classList.remove('show');

            // Prepare form data
            const formData = new FormData();
            formData.append('reference_image', refFile);
            formData.append('test_image', testFile);

            // Gather settings
            const settings = {
                operator_name: document.getElementById('operator_name').value,
                num_sample_points: parseInt(document.getElementById('num_sample_points').value),
                delta_e_threshold: parseFloat(document.getElementById('delta_e_threshold').value),
                delta_e_conditional: parseFloat(document.getElementById('delta_e_conditional').value),
                observer_angle: document.getElementById('observer_angle').value,
                ssim_pass_threshold: parseFloat(document.getElementById('ssim_pass_threshold').value),
                ssim_conditional_threshold: parseFloat(document.getElementById('ssim_conditional_threshold').value),
                enable_color_unit: document.getElementById('enable_color_unit').checked,
                enable_pattern_unit: document.getElementById('enable_pattern_unit').checked,
                enable_pattern_repetition: document.getElementById('enable_pattern_repetition').checked,
                enable_spectrophotometer: document.getElementById('enable_spectrophotometer').checked,
            };

            formData.append('settings', JSON.stringify(settings));

            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Show results
                    document.getElementById('loadingOverlay').classList.remove('show');
                    showResults(data);
                } else {
                    throw new Error(data.error || 'Analysis failed');
                }
            } catch (error) {
                document.getElementById('loadingOverlay').classList.remove('show');
                showError(error.message);
            }
        }

        function showResults(data) {
            const downloadButtons = document.getElementById('downloadButtons');
            downloadButtons.innerHTML = `
                <a href="/api/download/main/${data.main_report}" class="btn-download">
                    üì• Download Main Report
                </a>
                <a href="/api/download/tech/${data.tech_report}" class="btn-download">
                    ‚öôÔ∏è Download Settings Report
                </a>
            `;
            document.getElementById('results').classList.add('show');
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = '‚ùå Error: ' + message;
            errorDiv.classList.add('show');
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('settingsModal');
            if (event.target === modal) {
                closeSettings();
            }
        }
    </script>
</body>
</html>

